<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoría MVCG - Acceso Restringido</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            /* TEMA OSCURO */
            --window-bg: #1e1e1e;
            --content-bg: #262626;
            --titlebar-bg: #2d2d2d;
            --accent-color: #0A84FF;
            --text-main: #ffffff;
            --text-secondary: #aaaaaa;
            --card-bg: #333333;
            --input-bg: #3a3a3a;
            --border-color: #454545;
            --error-color: #ff453a;
            --success-color: #32d74b;
            --picker-height: 90px;
            --item-height: 40px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        
        body {
            background-color: #121212;
            background-image: radial-gradient(#2a2a2a 1px, transparent 1px);
            background-size: 30px 30px;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;
            overflow: hidden; 
        }

        /* --- PANTALLA DE LOGIN (NUEVO) --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000; /* Fondo negro total */
            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?q=80&w=2676&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(15px);
        }

        .login-card {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            width: 320px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: fadeIn 0.8s ease-out;
        }

        .user-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            background: #333; margin: 0 auto 20px;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; color: #fff; border: 2px solid rgba(255,255,255,0.2);
        }

        .login-title { color: white; font-size: 18px; margin-bottom: 20px; font-weight: 500; }

        .pass-input {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 15px; border-radius: 20px; color: white; width: 100%;
            font-size: 14px; margin-bottom: 15px; text-align: center; outline: none;
            transition: all 0.3s;
        }
        .pass-input:focus { border-color: var(--accent-color); background: rgba(0,0,0,0.5); }
        .pass-input.error { border-color: var(--error-color); animation: shake 0.3s; }

        .unlock-btn {
            background: rgba(255,255,255,0.1); color: white; border: none;
            padding: 8px 20px; border-radius: 15px; cursor: pointer; font-size: 13px;
            transition: 0.2s; font-weight: 500;
        }
        .unlock-btn:hover { background: rgba(255,255,255,0.2); }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }


        /* --- VENTANA PRINCIPAL (Oculta por defecto) --- */
        .mac-window {
            width: 600px; height: 90vh; max-height: 950px;
            background-color: var(--window-bg); border-radius: 12px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.8);
            display: none; /* OCULTO HASTA LOGIN */
            flex-direction: column; overflow: hidden; border: 1px solid #333;
            position: relative; z-index: 1; 
            animation: slideUpWindow 0.5s ease-out;
        }

        @keyframes slideUpWindow { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .title-bar {
            height: 38px; background: var(--titlebar-bg); display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #000; flex-shrink: 0;
        }
        .traffic-lights { position: absolute; left: 15px; display: flex; gap: 8px; }
        .light { width: 12px; height: 12px; border-radius: 50%; }
        .light.red { background: #ff5f56; border: 1px solid #ce3b32; } 
        .light.yellow { background: #ffbd2e; border: 1px solid #cca425; } 
        .light.green { background: #27c93f; border: 1px solid #1f9a2b; }
        .window-title { color: var(--text-secondary); font-size: 13px; font-weight: 500; }

        .window-content { padding: 25px; overflow-y: auto; flex-grow: 1; background-color: var(--content-bg); }

        /* UI ELEMENTS */
        .picker-section { display: flex; justify-content: space-between; background-color: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .picker-column { width: 48%; position: relative; text-align: center; }
        .picker-label { color: var(--accent-color); font-size: 11px; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; }
        .picker-wheel { height: var(--picker-height); overflow-y: scroll; scroll-snap-type: y mandatory; position: relative; }
        .picker-wheel::-webkit-scrollbar { display: none; }
        .picker-mask { position: absolute; top: 25px; left: 0; width: 100%; height: var(--picker-height); background: linear-gradient(to bottom, var(--card-bg) 0%, rgba(51,51,51, 0.1) 40%, rgba(51,51,51, 0.1) 60%, var(--card-bg) 100%); pointer-events: none; z-index: 2; }
        .picker-highlight { position: absolute; top: 50%; left: 0; width: 100%; height: var(--item-height); border-top: 1px solid var(--accent-color); border-bottom: 1px solid var(--accent-color); pointer-events: none; z-index: 1; transform: translateY(-50%); opacity: 0.5; }
        .picker-item { height: var(--item-height); display: flex; align-items: center; justify-content: center; scroll-snap-align: center; color: var(--text-secondary); font-size: 15px; font-weight: 500; transition: all 0.2s; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .input-box { background-color: var(--input-bg); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .full-width { grid-column: span 2; }
        .field-label { color: var(--text-secondary); font-size: 11px; margin-bottom: 4px; font-weight: 500; }
        .std-input { background: transparent; border: none; color: var(--text-main); font-size: 15px; outline: none; width: 100%; font-weight: 500; }
        .big-input { font-size: 22px; }

        .action-btn { background-color: var(--accent-color); color: white; border: none; border-radius: 8px; padding: 12px; font-size: 14px; font-weight: 600; width: 100%; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px; transition: 0.2s; }
        .action-btn:hover { filter: brightness(1.1); }
        .confirm-btn { background-color: var(--success-color); color: #000; margin-top: 15px; margin-bottom: 0; }

        .summary-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .sum-val { color: var(--text-main); font-weight: 700; font-size: 14px; }
        .status-ok { color: var(--success-color); } .status-err { color: var(--error-color); }

        .buttons-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .btn-small { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 8px; padding: 12px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px; }
        .btn-small:hover { background-color: var(--input-bg); }

        .saved-list-container { height: 180px; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--window-bg); margin-bottom: 15px; }
        .saved-item { background-color: var(--card-bg); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--accent-color); }
        
        .icon-btn { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-secondary); }
        .edit-icon:hover { color: var(--accent-color); } .del-icon:hover { color: var(--error-color); }
        
        .delete-all-btn { background: transparent; color: var(--error-color); border: 1px solid var(--error-color); width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: auto; }
        .delete-all-btn:hover { background: rgba(255, 69, 58, 0.1); }

        /* MODAL */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0, 0.6); backdrop-filter: blur(5px); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--window-bg); border: 1px solid var(--border-color); width: 90%; max-width: 450px; height: 85%; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .denominations-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .denom-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .denom-label { width: 25%; color: var(--accent-color); font-weight: 700; font-size: 14px; }
        .denom-input-group { width: 45%; }
        /* IMPORTANTE: Inputs de tipo texto para permitir comas */
        .denom-input { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-main); padding: 8px; font-size: 14px; width: 100%; text-align: center; }
        .denom-result { width: 30%; text-align: right; color: var(--text-secondary); font-size: 12px; }

        .response-toast { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; display: none; z-index: 300; border: 1px solid #555; }

        /* OVERLAY IMPRESIÓN */
        #printable-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #333; z-index: 9999; display: none;
            flex-direction: column; align-items: center; overflow: auto; padding: 20px;
        }

        #pdf-render-target {
            background-color: white; width: 816px; min-height: 1056px; padding: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); margin: 20px auto;
            color: black !important; font-family: Arial, sans-serif !important;
        }
        
        #loading-msg { color: white; font-size: 20px; font-weight: bold; margin: 20px; }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <div class="user-avatar">
                <span class="material-icons-round" style="font-size: 40px;">lock</span>
            </div>
            <div class="login-title">Auditoría MVCG</div>
            <input type="password" id="login-pass" class="pass-input" placeholder="Contraseña">
            <button class="unlock-btn" onclick="checkPassword()">Desbloquear</button>
        </div>
    </div>

    <div class="mac-window" id="main-app">
        <div class="title-bar">
            <div class="traffic-lights"><div class="light red"></div><div class="light yellow"></div><div class="light green"></div></div>
            <div class="window-title">Auditoría MVCG - Usuario Verificado</div>
        </div>

        <div class="window-content">
            <div class="picker-section">
                <div class="picker-column">
                    <div class="picker-label">Moneda</div>
                    <div class="picker-wheel" id="currency-wheel">
                        <ul class="picker-list">
                            <li class="picker-item" data-val="GTQ">Quetzales (Q)</li>
                            <li class="picker-item" data-val="USD">Dólares ($)</li>
                            <li class="picker-item" data-val="EUR">Euros (€)</li>
                        </ul>
                    </div>
                    <div class="picker-mask"></div><div class="picker-highlight"></div>
                </div>
                <div class="picker-column">
                    <div class="picker-label">Banco</div>
                    <div class="picker-wheel" id="bank-wheel">
                        <ul class="picker-list">
                            <li class="picker-item" data-val="BAM">BAM</li>
                            <li class="picker-item" data-val="GyT">G&T</li>
                            <li class="picker-item" data-val="CHN">CHN</li>
                            <li class="picker-item" data-val="BI">Industrial</li>
                            <li class="picker-item" data-val="Banrural">Banrural</li>
                        </ul>
                    </div>
                    <div class="picker-mask"></div><div class="picker-highlight"></div>
                </div>
            </div>

            <div class="form-grid">
                <div class="input-box full-width">
                    <span class="field-label">Valor Contenido</span>
                    <input type="text" id="declared-value" class="std-input big-input" placeholder="0.00" oninput="formatAndRecalculateMain(this)">
                </div>
                <div class="input-box">
                    <span class="field-label">No. Punto</span>
                    <input type="text" id="point-id" class="std-input" placeholder="Ej. 01">
                </div>
                <div class="input-box">
                    <span class="field-label">Nombre Punto</span>
                    <input type="text" id="point-name" class="std-input" placeholder="Ej. Caja 1">
                </div>
            </div>

            <button class="action-btn" onclick="openBillManager()">
                <span class="material-icons-round">payments</span> Administrar Billetes
            </button>

            <div class="summary-card">
                <div class="summary-row"><span class="sum-label">Piezas Físicas</span><span class="sum-val" id="total-pieces-display">0</span></div>
                <div class="summary-row"><span class="sum-label">Total Arqueado</span><span class="sum-val" id="total-counted-display">0.00</span></div>
                <div class="summary-row"><span class="sum-label">Diferencia</span><span class="sum-val diff-val status-ok" id="difference-display">0.00</span></div>
            </div>

            <div class="input-box full-width" style="margin-bottom:15px;">
                <span class="field-label">Observaciones</span>
                <input type="text" id="observations" class="std-input" placeholder="Agregar nota...">
            </div>

            <div class="buttons-grid">
                <button class="btn-small" onclick="saveCurrentData()">
                    <span class="material-icons-round" style="color:var(--success-color)">save</span> Guardar
                </button>
                <button class="btn-small" onclick="generatePDF()">
                    <span class="material-icons-round" style="color:var(--error-color)">picture_as_pdf</span> PDF
                </button>
            </div>

            <div style="color:var(--text-secondary); font-size:12px; margin-bottom:5px; font-weight:700;">REGISTROS GUARDADOS</div>
            <div class="saved-list-container" id="saved-list"></div>

            <button class="delete-all-btn" onclick="deleteAllData()">
                <span class="material-icons-round" style="font-size:16px;">delete_forever</span>
                ELIMINAR TODO
            </button>
        </div>

        <div class="modal-overlay" id="billModal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">Desglose de Efectivo</span>
                    <button class="close-btn" onclick="closeBillManager()"><span class="material-icons-round">close</span></button>
                </div>
                <div class="denominations-list" id="denom-container"></div>
                <button class="action-btn confirm-btn" onclick="closeBillManager()">
                    <span class="material-icons-round">check_circle</span> GUARDAR Y CERRAR
                </button>
            </div>
        </div>

        <div class="response-toast" id="toast">
            <strong id="toast-title">Info</strong> <span id="toast-msg">...</span>
        </div>
    </div>

    <div id="printable-overlay">
        <div id="loading-msg">Generando PDF con Detalle... Por favor espere.</div>
        <div id="pdf-render-target"></div>
    </div>

    <script>
        // --- SISTEMA DE LOGIN ---
        const APP_PASS = "97194612"; // Contraseña establecida

        // Event listener para tecla Enter
        document.getElementById('login-pass').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkPassword();
        });

        function checkPassword() {
            const input = document.getElementById('login-pass');
            if (input.value === APP_PASS) {
                // Correcto
                document.getElementById('login-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex'; // Mostrar app
                }, 500);
            } else {
                // Incorrecto
                input.classList.add('error');
                input.value = '';
                setTimeout(() => input.classList.remove('error'), 300);
            }
        }

        // --- APLICACIÓN PRINCIPAL ---
        let currentCurrency = 'GTQ';
        let currentBank = 'BAM';
        let totalCounted = 0;
        let totalPieces = 0;
        let savedRecords = []; 
        let currentBreakdown = {}; 

        const denominations = {
            'GTQ': [200, 100, 50, 20, 10, 5, 1, 1.00, 0.50, 0.25, 0.10, 0.05, 0.01], 
            'USD': [100, 50, 20, 10, 5, 1, 0.50, 0.25, 0.10, 0.05, 0.01],
            'EUR': [500, 200, 100, 50, 20, 10, 5, 2, 1, 0.50, 0.20, 0.10, 0.05, 0.01]
        };
        const currencySymbols = { 'GTQ': 'Q', 'USD': '$', 'EUR': '€' };

        // FORMATO VISUAL CON COMAS
        function fmt(num) {
            if(num === undefined || num === null || isNaN(num)) return "0.00";
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // LIMPIAR COMAS PARA CALCULAR
        function parseInput(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/,/g, ''));
        }

        // FUNCION PARA FORMATEAR INPUT MIENTRAS SE ESCRIBE
        function formatAndRecalculate(input) {
            let rawValue = input.value.replace(/,/g, '');
            if(rawValue === '') rawValue = '0';
            if(!isNaN(rawValue)) {
                const parts = rawValue.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                input.value = parts.join('.');
            }
            recalculateAll();
        }

        function formatAndRecalculateMain(input) {
            let rawValue = input.value.replace(/,/g, '');
            if(!isNaN(rawValue) && rawValue !== '') {
                const parts = rawValue.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                input.value = parts.join('.');
            }
            updateSummary();
        }

        window.onload = function() {
            loadFromStorage();
            updatePickerVisuals('currency-wheel', currentCurrency);
            updatePickerVisuals('bank-wheel', currentBank);
        };

        function setupPicker(wheelId) {
            const wheel = document.getElementById(wheelId);
            let timeout;
            wheel.addEventListener('scroll', () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    const itemHeight = 40; 
                    const index = Math.round(wheel.scrollTop / itemHeight);
                    const items = wheel.querySelectorAll('.picker-item');
                    if(items[index]) {
                        const newVal = items[index].getAttribute('data-val');
                        updatePickerVisuals(wheelId, newVal);
                        if (wheelId === 'currency-wheel' && newVal !== currentCurrency) {
                            currentCurrency = newVal;
                            totalCounted = 0; totalPieces = 0; currentBreakdown = {};
                            document.getElementById('denom-container').innerHTML = '';
                            updateSummary();
                        }
                        if (wheelId === 'bank-wheel') currentBank = newVal;
                    }
                }, 100);
            });
        }
        setupPicker('currency-wheel'); setupPicker('bank-wheel');

        function updatePickerVisuals(wheelId, activeVal) {
             const wheel = document.getElementById(wheelId);
             wheel.querySelectorAll('.picker-item').forEach((i, idx) => {
                 if(i.getAttribute('data-val') === activeVal) {
                     i.style.color = '#ffffff'; i.style.fontWeight = '700';
                     if(Math.abs(wheel.scrollTop - (idx * 40)) > 20) wheel.scrollTop = idx * 40;
                 } else { i.style.color = '#aaa'; i.style.fontWeight = '500'; }
             });
        }

        function updateSummary() {
            const declaredStr = document.getElementById('declared-value').value;
            const declared = parseInput(declaredStr);
            const symbol = currencySymbols[currentCurrency];

            document.getElementById('total-pieces-display').textContent = totalPieces.toFixed(0);
            document.getElementById('total-counted-display').textContent = `${symbol} ${fmt(totalCounted)}`;

            const diff = totalCounted - declared;
            const diffDisplay = document.getElementById('difference-display');
            
            let diffText = `${symbol} ${fmt(Math.abs(diff))}`;
            if (diff > 0.001) diffText = `+ ${diffText} (Sobra)`;
            else if (diff < -0.001) diffText = `- ${diffText} (Falta)`;
            else diffText = `${symbol} 0.00 (Cuadrado)`;
            
            diffDisplay.textContent = diffText;
            diffDisplay.className = Math.abs(diff) < 0.001 ? "sum-val diff-val status-ok" : "sum-val diff-val status-err";
        }

        function openBillManager() {
            const modal = document.getElementById('billModal');
            const container = document.getElementById('denom-container');
            if(container.innerHTML === '') {
                 const denoms = denominations[currentCurrency];
                 const symbol = currencySymbols[currentCurrency];
                 denoms.forEach(val => {
                    let savedVal = currentBreakdown[val] || ''; 
                    if(savedVal !== '') savedVal = fmt(savedVal);

                    let labelText = `${symbol} ${val}`;
                    if(currentCurrency === 'GTQ') {
                        if(val >= 2) labelText = `Billete ${symbol} ${val}`;
                        else labelText = `Moneda ${symbol} ${val}`;
                    }
                    const row = document.createElement('div');
                    row.className = 'denom-row';
                    row.innerHTML = `
                        <div class="denom-label">${labelText}</div>
                        <div class="denom-input-group">
                            <input type="text" inputmode="decimal" class="denom-input" data-denom="${val}" placeholder="0" value="${savedVal}" oninput="formatAndRecalculate(this)">
                        </div>
                        <div class="denom-result"><span class="piece-count">0</span> pzs</div>`;
                    container.appendChild(row);
                 });
                 recalculateAll();
            }
            modal.style.display = 'flex';
        }
        function closeBillManager() { document.getElementById('billModal').style.display = 'none'; }

        window.recalculateAll = function() {
            const inputs = document.querySelectorAll('.denom-input');
            let tempTotalVal = 0; let tempTotalPieces = 0;
            currentBreakdown = {}; 
            inputs.forEach(input => {
                const valStr = input.value;
                const val = parseInput(valStr); 
                const denom = parseFloat(input.getAttribute('data-denom'));
                
                if(val > 0) currentBreakdown[denom] = val;
                
                const piecesSpan = input.parentElement.parentElement.querySelector('.piece-count');
                if (val > 0) {
                    const p = val / denom;
                    piecesSpan.textContent = Number.isInteger(p) ? p : p.toFixed(2);
                    tempTotalPieces += p;
                } else { piecesSpan.textContent = "0"; }
                tempTotalVal += val;
            });
            totalCounted = tempTotalVal; totalPieces = tempTotalPieces;
            updateSummary();
        };

        function saveCurrentData() {
            const pointId = document.getElementById('point-id').value;
            const pointName = document.getElementById('point-name').value;
            const obs = document.getElementById('observations').value;
            const declared = parseInput(document.getElementById('declared-value').value);

            if (!pointId || !pointName) { showToast("Error", "Faltan datos del punto."); return; }

            const record = {
                id: Date.now(),
                date: new Date(),
                bank: currentBank,
                currency: currentCurrency,
                pointId: pointId,
                pointName: pointName,
                declared: declared,
                counted: totalCounted,
                pieces: totalPieces,
                diff: totalCounted - declared,
                breakdown: JSON.parse(JSON.stringify(currentBreakdown)),
                observations: obs
            };

            savedRecords.push(record);
            localStorage.setItem('audit_data_final_secure', JSON.stringify(savedRecords));
            renderSavedList();
            showToast("Guardado", "Registro añadido.");
            clearForm();
        }

        function renderSavedList() {
            const container = document.getElementById('saved-list');
            container.innerHTML = '';
            savedRecords.forEach((rec, index) => {
                const symbol = currencySymbols[rec.currency];
                const item = document.createElement('div');
                item.className = 'saved-item';
                item.innerHTML = `
                    <div class="saved-info">
                        <span class="saved-point">#${rec.pointId} - ${rec.pointName}</span>
                        <span class="saved-meta">${rec.bank} • ${rec.pieces.toFixed(0)} pzs</span>
                    </div>
                    <div style="flex-grow:1; display:flex; justify-content:flex-end; align-items:center;">
                         <span class="saved-amount">${symbol} ${fmt(rec.counted)}</span>
                         <div class="saved-actions">
                            <button class="icon-btn edit-icon" onclick="loadRecord(${index})"><span class="material-icons-round">edit</span></button>
                            <button class="icon-btn del-icon" onclick="deleteRecord(${index})"><span class="material-icons-round">delete</span></button>
                        </div>
                    </div>`;
                container.appendChild(item);
            });
        }

        function deleteRecord(index) {
            savedRecords.splice(index, 1);
            localStorage.setItem('audit_data_final_secure', JSON.stringify(savedRecords));
            renderSavedList();
        }

        function loadRecord(index) {
            const rec = savedRecords[index];
            document.getElementById('point-id').value = rec.pointId;
            document.getElementById('point-name').value = rec.pointName;
            document.getElementById('declared-value').value = fmt(rec.declared);
            document.getElementById('observations').value = rec.observations || "";
            
            currentCurrency = rec.currency; currentBank = rec.bank;
            currentBreakdown = rec.breakdown;
            document.getElementById('denom-container').innerHTML = '';
            
            let tV = 0, tP = 0;
            for (const [denom, val] of Object.entries(currentBreakdown)) {
                tV += parseFloat(val); tP += (parseFloat(val) / parseFloat(denom));
            }
            totalCounted = tV; totalPieces = tP;
            
            updateSummary();
            updatePickerVisuals('currency-wheel', currentCurrency);
            updatePickerVisuals('bank-wheel', currentBank);
            deleteRecord(index);
            showToast("Cargado", "Listo para editar.");
        }

        function clearForm() {
            document.getElementById('declared-value').value = '';
            document.getElementById('point-id').value = '';
            document.getElementById('point-name').value = '';
            document.getElementById('observations').value = '';
            totalCounted = 0; totalPieces = 0; currentBreakdown = {};
            document.getElementById('denom-container').innerHTML = ''; 
            updateSummary();
        }

        function deleteAllData() {
            if(confirm("¿Eliminar TODOS los datos?")) {
                savedRecords = [];
                localStorage.removeItem('audit_data_final_secure');
                renderSavedList(); clearForm();
            }
        }

        function loadFromStorage() {
            const data = localStorage.getItem('audit_data_final_secure');
            if(data) {
                savedRecords = JSON.parse(data);
                savedRecords.forEach(r => r.date = new Date(r.date));
                renderSavedList();
            }
        }

        function showToast(title, msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-msg').textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- GENERADOR PDF ---
        function generatePDF() {
            if (savedRecords.length === 0) { showToast("Error", "No hay datos para PDF."); return; }
            
            const overlay = document.getElementById('printable-overlay');
            const target = document.getElementById('pdf-render-target');
            overlay.style.display = 'flex';
            
            target.innerHTML = '';
            let htmlContent = '';
            
            for (let i = 0; i < savedRecords.length; i += 4) {
                const chunk = savedRecords.slice(i, i + 4);
                let pageHtml = `<div style="width:100%; display:flex; flex-wrap:wrap; gap:20px; page-break-after:always; margin-bottom:20px;">`;
                
                chunk.forEach(rec => {
                    const symbol = currencySymbols[rec.currency];
                    const dateStr = rec.date.toLocaleDateString('es-GT');
                    const timeStr = rec.date.toLocaleTimeString('es-GT');
                    const obs = rec.observations ? rec.observations : "---";
                    
                    let diffLabel = "CUADRADO";
                    let colorDiff = "color:#000;";
                    if(rec.diff > 0.001) { diffLabel = "SOBRANTE"; colorDiff = "color:red;"; }
                    if(rec.diff < -0.001) { diffLabel = "FALTANTE"; colorDiff = "color:red;"; }

                    let breakdownRows = '';
                    const sortedKeys = Object.keys(rec.breakdown).sort((a,b) => parseFloat(b) - parseFloat(a));
                    
                    sortedKeys.forEach(k => {
                        const totalVal = parseFloat(rec.breakdown[k]);
                        const count = totalVal / parseFloat(k);
                        if(totalVal > 0) {
                            breakdownRows += `
                            <tr>
                                <td style="font-size:9px; color:#333; padding:1px;">${symbol} ${k}</td>
                                <td style="font-size:9px; color:#333; text-align:center; padding:1px;">x ${count % 1 === 0 ? count : count.toFixed(2)}</td>
                                <td style="font-size:9px; color:#000; text-align:right; font-family:monospace; padding:1px;">${fmt(totalVal)}</td>
                            </tr>`;
                        }
                    });

                    pageHtml += `
                    <div style="width:48%; height:460px; border:2px solid #000; border-radius:5px; padding:15px; display:flex; flex-direction:column; justify-content:space-between; background:#fff; color:#000;">
                        
                        <div style="border-bottom:2px solid #000; padding-bottom:5px; margin-bottom:5px;">
                            <div style="font-size:16px; font-weight:bold; color:#000;">PUNTO #${rec.pointId}</div>
                            <div style="font-size:14px; font-weight:bold; color:#000;">${rec.pointName}</div>
                            <div style="font-size:12px; color:#000;">Banco: ${rec.bank}</div>
                        </div>
                        
                        <div style="flex-grow:1;">
                            <table style="width:100%; border-collapse:collapse;">
                                <tr><td style="padding:2px 0; font-size:11px; color:#000;">Declarado:</td>
                                    <td style="padding:2px 0; font-size:11px; color:#000; text-align:right; font-weight:bold;">${symbol} ${fmt(rec.declared)}</td></tr>
                                <tr><td style="padding:2px 0; font-size:11px; color:#000;">Arqueado:</td>
                                    <td style="padding:2px 0; font-size:11px; color:#000; text-align:right; font-weight:bold;">${symbol} ${fmt(rec.counted)}</td></tr>
                                <tr><td style="padding:2px 0; font-size:11px; color:#000;">Diferencia:</td>
                                    <td style="padding:2px 0; font-size:11px; ${colorDiff} text-align:right; font-weight:bold;">${symbol} ${fmt(rec.diff)}</td></tr>
                            </table>

                            <div style="margin-top:5px; border-top:1px dashed #aaa; padding-top:2px;">
                                <div style="font-size:10px; font-weight:bold; color:#000;">Detalle:</div>
                                <table style="width:100%; border-collapse:collapse;">${breakdownRows}</table>
                            </div>
                            
                            <div style="margin-top:5px; font-size:10px; color:#333; font-style:italic;">Obs: ${obs}</div>
                        </div>
                        
                        <div style="margin-top:20px; border-top:1px solid #000; padding-top:5px; text-align:center; color:#000;">
                            <div style="font-size:10px; font-weight:bold;">QUETZALTENANGO, QUETZALTENANGO</div>
                            <div style="font-size:9px;">${dateStr} - ${timeStr}</div>
                            <div style="font-size:8px; margin-top:2px;">M.V.C.G.</div>
                        </div>
                    </div>`;
                });

                pageHtml += '</div>';
                htmlContent += pageHtml;
            }
            target.innerHTML = htmlContent;

            setTimeout(() => {
                const opt = { 
                    margin: 0.2, 
                    filename: `Auditoria_${Date.now()}.pdf`, 
                    image: { type: 'jpeg', quality: 0.98 }, 
                    html2canvas: { scale: 2, useCORS: true }, 
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
                };
                
                html2pdf().set(opt).from(target).save().then(() => {
                     overlay.style.display = 'none';
                     showToast("Éxito", "PDF Descargado");
                });
            }, 500);
        }
    </script>
</body>
</html>